# AiFrame YandexArt

Фоторамка с генерацией изображений через YandexArt.

Сделана на основе оригинального проекта ["Фоторамка с нейросетью"](https://github.com/AlexGyver/AiFrame) Гайвера.
Так же были использованы решения, предложенные в обсуждении оригинального проекта. 
За что я хотел бы выразить благодарность.

Код адаптирован под использование API YandexArt.
В настоящий момент за генерацию изображений Яндекс взимает плату. (На момент написания этого файла: 2руб 20коп)

## Настройка
### На стороне Яндекс
1. зарегистрироваться на YandexCloud.
2. В консоли управления YandexCloud создать каталог
3. Созданному каталогу выдать роль, дающую право на генерацию изображения (идентификатор каталога запомнить)
4. Создать сервисный аккаунт
5. В сервисном аккаунте создать ApiKey с аналогичной ролью (код ключа запомнить. **ВНИМАНИЕ!** Консоль после генерации показывает его только один раз)

### На стороне рамки
   Процесс настройки такой же, как в оригинальном проекте.

1. Запустить рамку
2. Присоединиться к WiFi сети рамки **Yandex Art AP**
3. На странице настроек рамки указать параметры для присоединения к домашней WiFi сети
4. Войти в настройки рамки со стороны домашней сети
5. В настройках API указать идентификатор каталога и ApiKey

### Особенности реализации

#### Дисплей
Проект настроен на работу с IPS дисплеем на чипе ILI9488. 
Необходимая библиотека лежит в каталоге libraries.

Подключение дисплея к микроконтроллеру описано в файле tft.h
Если необходимо поменть ориентацию дисплея, поменяйте в этом же файле параметр 

```
tft.setRotation(2);
```

#### Изображение
Исходный проект работал с ИИ от Сбера. 
При генерации изображения возможно было точно задать соотношение сторон в пикселях. 
Это позволяет масштабировать изображение кратно 2. Что умеет делать библиотека **tjpgd**
При генерации изображения в YandexApi возможно задать лишь сотношение сторон. 
Размер в пикселях выбирается ИИ самостоятельно. Он примерно 1280х832 и по отношению к 480х320 не кратен двойке.
Поэтому в процессе обработки изображения оно масштабируется вдвое, а затем на экран выводится его центральная часть (каря отбрасываются).
Расположение центральной части относительно всего рисунка ( с учетом того, что он уже уменьшен вдвое) задаётся константами

```
// Константы, определяющие внутреннюю область
const int INTERNAL_X = 48;
const int INTERNAL_Y = 80;
const int INTERNAL_WIDTH = 320;
const int INTERNAL_HEIGHT = 480;
```
Указаны отступы по х и у и ширина и высота прямоугольника точек.

Кроме того, на моём экране изображение выводилось в негативе и в обработку пришлось добавить инверсию цветов (возможно это решается настройками, но я не нашёл).

#### Особенности промта
В API нет возможности указат стиль и негативный промт отдельными частями запроса. Поэтому эти поля на WEB-странице рамки убраны.

#### Код
Я отключил изменения по OTA, так как не особо понимаю, что с этим делать (а пока "и так сойдёт" (с) ).

### Ручной запрос и проверка генерации

В своих экспериментах я использовал ручную генерацию запросов к YandexArt. (На момент создания запросы были такие)

#### Генерация
Запрос генерации (в ответ вы получите идентификатор задачи)

```
curl --location 'https://llm.api.cloud.yandex.net/foundationModels/v1/imageGenerationAsync' \
--header 'Authorization: Api-Key AQVN....<ВАШ КЛЮЧ>...' \
--header 'Content-Type: application/json' \
--data '{
"model_uri":"art://b1g...<Ваш ИДЕНТИФИКАТОР КАТАЛОГА>.../yandex-art/latest",
"messages":[{"text":"test <ВАШ ПРОМТ>","weight":1}],
"generation_options":{"mime_type":"image/jpeg", 
 "aspectRatio": {
     "widthRatio": "320",
     "heightRatio": "480"
   }
   }
}'
```
#### Проверка готовности

Проверка готовности (если изображение готово, оно так же придёт в ответе)

```
curl --location 'https://llm.api.cloud.yandex.net/operations/fbvs...<ВАШ ИДЕНТИФИКАТОР ЗАДАНИЯ>...' \
--header 'Authorization: Api-Key AQVN....<ВАШ КЛЮЧ>...' \
--data ''
```


